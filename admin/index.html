<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager | Sharif Abubakar Portfolio</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      margin: 0;
      padding: 0;
    }
    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100%;
      background-color: #f8f9fa;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;
    }
    .loader-inner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
      display: none;
      background-color: #f8d7da;
      color: #721c24;
      padding: 20px;
      margin: 20px;
      border-radius: 5px;
      text-align: center;
    }
    .error-message button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div id="loader" class="loader">
    <div class="loader-inner"></div>
  </div>
  
  <div id="error" class="error-message">
    <h2>Error Loading CMS</h2>
    <p>There was a problem loading the content management system.</p>
    <p>This could be due to a network issue or a configuration problem.</p>
    <button onclick="window.location.reload()">Try Again</button>
  </div>

  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.10.17/dist/netlify-cms.js"></script>
  
  <!-- Custom CMS configuration -->
  <script>
    // Wait for CMS to load
    window.addEventListener('load', function() {
      // Add custom error handling for media uploads
      if (window.CMS) {
        // Fix for getIn error
        const originalInitWidgets = window.CMS.registerWidget;
        window.CMS.registerWidget = function(name, control, preview) {
          if (control && control.prototype) {
            const originalRender = control.prototype.render;
            control.prototype.render = function() {
              // Add a safe getIn method if it doesn't exist
              if (this.props && this.props.value && !this.props.value.getIn && typeof this.props.value === 'object') {
                this.props.value.getIn = function(path) {
                  let result = this;
                  for (let i = 0; i < path.length; i++) {
                    if (result == null) return undefined;
                    result = result[path[i]];
                  }
                  return result;
                }.bind(this.props.value);
              }
              return originalRender.apply(this, arguments);
            };
          }
          return originalInitWidgets.call(this, name, control, preview);
        };
        
        CMS.registerEventListener({
          name: 'preSave',
          handler: function(data) {
            console.log('Preparing to save:', data);
            return data;
          }
        });
        
        // Log media errors
        CMS.registerEventListener({
          name: 'mediaLibrary',
          handler: function(data) {
            console.log('Media library event:', data);
          }
        });
      }
    });
  </script>
  
  <script>
    // Show loader
    document.getElementById('loader').style.display = 'flex';
    
    // Handle errors
    window.addEventListener('error', function(event) {
      document.getElementById('loader').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      console.error('CMS Error:', event.message);
    });
    
    // Initialize Netlify Identity
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
    
    // Hide loader when CMS is loaded
    window.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        document.getElementById('loader').style.display = 'none';
        
        // Add image upload link to the header
        const header = document.querySelector('.css-12b66la-AppHeaderContent');
        if (header) {
          const uploadLink = document.createElement('a');
          uploadLink.href = '/image-upload';
          uploadLink.textContent = 'Quick Image Upload';
          uploadLink.style.marginLeft = '20px';
          uploadLink.style.color = '#798291';
          uploadLink.style.textDecoration = 'none';
          uploadLink.style.fontWeight = '500';
          uploadLink.target = '_blank';
          header.appendChild(uploadLink);
        }
      }, 2000);
    });
    
    // Debug info
    console.log('Netlify CMS Version:', window.CMS ? window.CMS.version : 'Not loaded');
  </script>
</body>
</html>